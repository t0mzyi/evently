<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Venue â€” Evently Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              theme: {
                primary: "#1C2A3A",
                accent: "#ED8842",
              },
            },
            fontFamily: {
              heading: ["Fraunces", "serif"],
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      .input-error { border: 1px solid #af3131ff !important; }
      .error-text { color: #f87171; font-size: 10px; letter-spacing: 0.08em; margin-top: 4px; padding-left: 4px; font-weight: 700; text-transform: uppercase; }
      .preview-card { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>

  <body class="bg-[#EAE0CF] text-[#1C2A3A] min-h-screen font-sans">
    <main class="pt-32 pb-16 px-6 max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <div>
          <a href="/admin/venues" class="inline-flex items-center gap-2 text-sm font-bold uppercase tracking-widest text-[#1C2A3A]/60 hover:text-[#1C2A3A] mb-4">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Back to Venues
          </a>
          <h1 class="text-4xl font-heading font-medium tracking-tight mb-2">Edit Venue</h1>
          <p class="text-[#1C2A3A]/60">Update details for <%= venue.name %>.</p>
        </div>
        <button type="button" onclick="confirmDelete('<%= venue._id %>')" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg text-xs font-bold uppercase hover:bg-red-200 transition-colors">Delete Venue</button>
      </div>

      <div class="bg-white/60 backdrop-blur-xl rounded-[2.5rem] p-8 md:p-12 shadow-sm border border-white/40">
        <form id="editVenueForm" class="space-y-8" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="col-span-2">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Venue Name</label>
              <input type="text" name="name" id="name" value="<%= venue.name %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none focus:bg-white transition-all" />
              <p class="error-text hidden">Venue name is required</p>
            </div>

            <div>
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Venue Type</label>
              <select name="type" id="type" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none appearance-none cursor-pointer">
                <option value="Indoor" <%= venue.type === 'Indoor' ? 'selected' : '' %>>Indoor</option>
                <option value="Outdoor" <%= venue.type === 'Outdoor' ? 'selected' : '' %>>Outdoor</option>
                <option value="Rooftop" <%= venue.type === 'Rooftop' ? 'selected' : '' %>>Rooftop</option>
                <option value="Stadium" <%= venue.type === 'Stadium' ? 'selected' : '' %>>Stadium</option>
                <option value="Other" <%= venue.type === 'Other' ? 'selected' : '' %>>Other</option>
              </select>
            </div>

            <div>
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Capacity</label>
              <input type="number" name="capacity" id="capacity" value="<%= venue.capacity %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none transition-all" />
              <p class="error-text hidden">Enter a valid capacity</p>
            </div>

            <div class="col-span-2">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Address</label>
              <input type="text" name="address" id="address" value="<%= venue.address %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none transition-all" />
              <p class="error-text hidden">Address is required</p>
            </div>

            <div class="col-span-2">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Google Maps URL</label>
              <input type="url" name="map_url" id="map_url" value="<%= venue.map_url %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none transition-all" />
              <p class="error-text hidden">Enter a valid URL</p>
            </div>
          </div>

          <div>
            <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Description</label>
            <textarea name="description" id="description" rows="4" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none transition-all"><%= venue.description %></textarea>
            <p class="error-text hidden">Description is required</p>
          </div>

          <div class="pt-4 border-t border-[#1C2A3A]/5">
            <div class="flex justify-between items-end mb-3">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40">Venue Images</label>
              <span class="text-[9px] font-black uppercase tracking-tighter text-orange-600 bg-orange-100 px-2 py-0.5 rounded">First image is cover</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="image-upload-wrapper">
              <% venue.image_url.forEach((url, index) => { %>
                <div class="preview-card relative aspect-square rounded-2xl overflow-hidden border border-[#1C2A3A]/10 bg-white group existing-image" data-url="<%= url %>">
                  <img src="<%= url %>" class="w-full h-full object-cover">
                  <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <button type="button" onclick="removeExistingImage(this)" class="bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                  </div>
                  <div class="cover-badge absolute top-2 left-2 bg-orange-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded <%= index === 0 ? '' : 'hidden' %>">COVER</div>
                </div>
              <% }) %>
              <div onclick="document.getElementById('new_images').click()" class="aspect-square border-2 border-dashed border-[#1C2A3A]/10 rounded-2xl flex flex-col items-center justify-center hover:bg-white/50 transition-colors cursor-pointer order-last">
                <svg class="w-6 h-6 text-[#1C2A3A]/20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <p class="text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mt-2">Add New</p>
                <input type="file" id="new_images" multiple accept="image/*" class="hidden" />
              </div>
            </div>
            <p id="image-error" class="error-text hidden">At least one image is required</p>
          </div>

          <div class="pt-4 border-t border-[#1C2A3A]/5">
            <div class="flex items-center justify-between mb-4">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40">Amenities</label>
              <button type="button" onclick="addAmenity()" class="text-xs font-bold text-[#1C2A3A] hover:opacity-70 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Add Amenity
              </button>
            </div>
            <div id="amenities-container" class="space-y-3">
              <% venue.amenities.forEach(amenity => { %>
                <div class="grid grid-cols-[1fr_1fr_40px] gap-4 items-center amenity-row">
                  <input type="text" name="amenity_key[]" value="<%= amenity.key %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 text-[#1C2A3A] focus:outline-none transition-all">
                  <input type="text" name="amenity_value[]" value="<%= amenity.value %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 text-[#1C2A3A] focus:outline-none transition-all">
                  <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 flex justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  </button>
                </div>
              <% }) %>
            </div>
          </div>

          <div class="pt-8 flex justify-end gap-3">
            <button type="submit" id="submitBtn" class="px-8 py-4 bg-[#1C2A3A] text-white rounded-2xl font-heading text-lg hover:scale-[1.02] transition-transform shadow-xl">Save Changes</button>
          </div>
        </form>
      </div>
    </main>

    <script>
      let newSelectedFiles = [];
      const imageUploadWrapper = document.getElementById("image-upload-wrapper");

      // File Previews
      document.getElementById("new_images").addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        files.forEach((file) => {
          const fileId = Math.random().toString(36).substring(2, 9);
          file.customId = fileId;
          newSelectedFiles.push(file);
          const reader = new FileReader();
          reader.onload = (event) => {
            const div = document.createElement("div");
            div.className = "preview-card relative aspect-square rounded-2xl overflow-hidden border border-[#1C2A3A]/10 bg-white group new-preview";
            div.id = `new-preview-${fileId}`;
            div.innerHTML = `
              <img src="${event.target.result}" class="w-full h-full object-cover">
              <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                <button type="button" onclick="removeNewImage('${fileId}')" class="bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </div>
              <div class="cover-badge absolute top-2 left-2 bg-orange-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded hidden">COVER</div>
            `;
            imageUploadWrapper.insertBefore(div, imageUploadWrapper.lastElementChild);
            refreshCoverBadges();
          };
          reader.readAsDataURL(file);
        });
      });

      function removeExistingImage(btn) {
        btn.closest(".existing-image").remove();
        refreshCoverBadges();
      }

      function removeNewImage(id) {
        newSelectedFiles = newSelectedFiles.filter((f) => f.customId !== id);
        document.getElementById(`new-preview-${id}`).remove();
        refreshCoverBadges();
      }

      function refreshCoverBadges() {
        const all = imageUploadWrapper.querySelectorAll(".existing-image, .new-preview");
        all.forEach((card, i) => {
          const badge = card.querySelector(".cover-badge");
          badge.classList.toggle("hidden", i !== 0);
        });
      }

      function addAmenity() {
        const container = document.getElementById("amenities-container");
        const newRow = document.createElement("div");
        newRow.className = "grid grid-cols-[1fr_1fr_40px] gap-4 items-center mt-3 amenity-row";
        newRow.innerHTML = `
          <input type="text" name="amenity_key[]" placeholder="Key" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none transition-all">
          <input type="text" name="amenity_value[]" placeholder="Value" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none transition-all">
          <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 flex justify-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
          </button>`;
        container.appendChild(newRow);
      }

      // Submit Logic
      document.getElementById("editVenueForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = document.getElementById("submitBtn");
        let isValid = true;

        const check = (id, condition) => {
          const el = document.getElementById(id);
          const err = el.closest("div").querySelector(".error-text");
          if (condition) { el.classList.remove("input-error"); if (err) err.classList.add("hidden"); } 
          else { el.classList.add("input-error"); if (err) err.classList.remove("hidden"); isValid = false; }
        };

        check("name", document.getElementById("name").value.trim() !== "");
        check("capacity", document.getElementById("capacity").value > 0);
        check("address", document.getElementById("address").value.trim() !== "");

        const existingCount = document.querySelectorAll(".existing-image").length;
        const totalImages = existingCount + newSelectedFiles.length;
        const imgErr = document.getElementById("image-error");
        if (totalImages === 0) { imgErr.classList.remove("hidden"); isValid = false; } else { imgErr.classList.add("hidden"); }

        if (!isValid) return;

        btn.disabled = true;
        btn.innerText = "Updating...";

        const formData = new FormData(e.target);
        const remainingImages = Array.from(document.querySelectorAll(".existing-image")).map(el => el.dataset.url);
        formData.append("remaining_images", JSON.stringify(remainingImages));
        newSelectedFiles.forEach(f => formData.append("images[]", f));

        try {
          const response = await fetch(`/admin/venues/<%= venue._id %>/edit`, {
            method: "PATCH",
            body: formData
          });
          const data = await response.json();
          if (data.success) window.location.href = "/admin/venues";
          else { console.log(data.error || "Update failed"); btn.disabled = false; btn.innerText = "Save Changes"; }
        } catch (err) { console.error(err); btn.disabled = false; }
      });

      async function confirmDelete(id) {
        if (confirm("Permanently delete this venue?")) {
          const res = await fetch(`/admin/venues/delete/${id}`, { method: 'DELETE' });
          if ((await res.json()).success) window.location.href = "/admin/venues";
        }
      }
    </script>
  </body>
</html>