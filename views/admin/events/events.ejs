<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Management — Evently Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            theme: {
              primary: '#1C2A3A',
              highlight: '#2C3E50',
              accent: '#ED8842',
              surface: '#F9F7F5'
            },
          },
          fontFamily: {
            heading: ['Fraunces', 'serif'],
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body class="bg-[#EAE0CF] text-[#1C2A3A] min-h-screen">
  <%- include('../../partials/toast')%>
  <!-- Admin Navbar -->
  <%-include('../../partials/adminNavbar') %>

  <main class="pt-32 pb-16 px-6 max-w-7xl mx-auto">
    <!-- Header with Filters -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-8">
      <div>
        <h1 class="text-4xl font-heading font-medium tracking-tight mb-2">Event Management</h1>
        <p class="text-[#1C2A3A]/60">Review and manage all platform events</p>
      </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white/60 backdrop-blur-xl rounded-xl p-4 border border-white/40">
        <p class="text-2xl font-heading font-bold text-[#1C2A3A]"><%= totalEvents %></p>
        <p class="text-xs text-[#1C2A3A]/60 uppercase tracking-wider">Total Events</p>
      </div>
      <div class="bg-yellow-500/10 backdrop-blur-xl rounded-xl p-4 border border-yellow-500/20">
        <p class="text-2xl font-heading font-bold text-yellow-700"><%= pendingEvents %></p>
        <p class="text-xs text-yellow-700/80 uppercase tracking-wider">Pending Approval</p>
      </div>
      <div class="bg-green-500/10 backdrop-blur-xl rounded-xl p-4 border border-green-500/20">
        <p class="text-2xl font-heading font-bold text-green-700"><%= approvedEvents %></p>
        <p class="text-xs text-green-700/80 uppercase tracking-wider">Approved</p>
      </div>
      <div class="bg-red-500/10 backdrop-blur-xl rounded-xl p-4 border border-red-500/20">
        <p class="text-2xl font-heading font-bold text-red-700"><%= rejectedEvents %></p>
        <p class="text-xs text-red-700/80 uppercase tracking-wider">Rejected</p>
      </div>
    </div>
    <div class="bg-white/40 backdrop-blur-md rounded-2xl p-4 mb-8 border border-white/20">
      <form action="/admin/events" method="GET" class="flex flex-col md:flex-row items-center gap-6">
        <input type="hidden" name="p" value="1">

        <div class="relative w-full md:flex-1">
          <input type="search" name="n" value="<%= searchQuery %>" placeholder="Search venues by name..." class="w-full px-4 py-2.5 bg-white/80 border border-[#1C2A3A]/10 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-[#ED8842]/40" />
        </div>

        <div class="flex flex-wrap items-center gap-6 w-full md:w-auto">
          <div class="relative min-w-[140px]">
            <select name="t" onchange="this.form.submit()" class="w-full appearance-none pl-4 pr-10 py-2.5 bg-white/80 border border-[#1C2A3A]/10 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-[#ED8842]/40 cursor-pointer">
              <option value="all" <%= selectedType === 'all' ? 'selected' : '' %>>All </option>
              <option value="pending" <%= selectedType === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="approved" <%= selectedType === 'approved' ? 'selected' : '' %>>Approved</option>
              <option value="rejected" <%= selectedType === 'rejected' ? 'selected' : '' %>>Rejected</option>
            </select>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-[#1C2A3A]/40">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>

          <div class="relative min-w-[160px]">
            <select name="s" onchange="this.form.submit()" class="w-full appearance-none pl-4 pr-10 py-2.5 bg-white/80 border border-[#1C2A3A]/10 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-[#ED8842]/40 cursor-pointer">
              <option value="name-asc" <%= selectedSort === 'name-asc' ? 'selected' : '' %>>Name A-Z</option>
              <option value="name-desc" <%= selectedSort === 'name-desc' ? 'selected' : '' %>>Name Z-A</option>
              <option value="createdAt-desc" <%= selectedSort === 'createdAt-desc' ? 'selected' : '' %>>Newest</option>
              <option value="createdAt-asc" <%= selectedSort === 'createdAt-asc' ? 'selected' : '' %>>oldest</option>
            </select>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-[#1C2A3A]/40">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Events Table -->
    <div class="bg-white/60 backdrop-blur-xl rounded-[2rem] border border-white/40 shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-[#1C2A3A]/5 border-b border-[#1C2A3A]/10">
            <tr>
              <th class="px-6 py-4 text-left text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/60">Event ID</th>
              <th class="px-6 py-4 text-left text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/60">Event Name</th>
              <th class="px-6 py-4 text-left text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/60">Organizer</th>
              <th class="px-6 py-4 text-left text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/60">Date</th>
              <th class="px-6 py-4 text-left text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/60">Status</th>
              <th class="px-6 py-4 text-right text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/60">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[#1C2A3A]/5">
            <% if (events.length === 0) { %>
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-[#1C2A3A]/60">No events found.</td>
            </tr>
            <% } else { %>
            <% for(let i = 0; i < events.length; i++) { %>
            <tr class="hover:bg-white/50 transition-colors">
              <td class="px-6 py-4 text-sm font-mono text-[#1C2A3A]/60"><%= events[i]._id %></td>
              <td class="px-6 py-4">
                <p class="font-medium text-[#1C2A3A]"><%= events[i].title %></p>
                <p class="text-xs text-[#1C2A3A]/60 mt-1"><%= events[i].categoryId?.name || '—' %></p>
              </td>
              <td class="px-6 py-4 text-sm text-[#1C2A3A]">
                <%= (events[i].hostId?.firstName || '') + ' ' + (events[i].hostId?.lastName || '') || '—' %>
              </td>
              <td class="px-6 py-4 text-sm text-[#1C2A3A]/60"><%= events[i].formatDate %></td>

              <% if(events[i].status === "pending") { %>
              <td class="px-6 py-4">
                <span class="px-3 py-1 bg-yellow-500/10 text-yellow-700 rounded-full text-xs font-bold uppercase tracking-wider">Pending</span>
              </td>
              <td class="px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">
                  <button class="px-4 py-2 bg-green-500 text-white rounded-lg text-xs font-bold hover:bg-green-600 transition-colors">Approve</button>
                  <button onclick="openRejectModal('<%= events[i]._id %>')" class="px-4 py-2 bg-red-500 text-white rounded-lg text-xs font-bold hover:bg-red-600 transition-colors">Reject</button>
                  <a href="/admin/events/<%= events[i]._id%>">
                    <svg class="w-4 h-4 text-[#1C2A3A]/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                  </a>
                  </button>
                </div>
              </td>
              <% } else if(events[i].status === "approved") { %>
              <td class="px-6 py-4">
                <span class="px-3 py-1 bg-green-500/10 text-green-700 rounded-full text-xs font-bold uppercase tracking-wider">Approved</span>
              </td>
              <td class="px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">

                  <button class="p-2 hover:bg-[#1C2A3A]/5 rounded-lg transition-colors">
                    <a href="/admin/events/<%= events[i]._id%>">
                      <svg class="w-4 h-4 text-[#1C2A3A]/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                      </svg>
                    </a>
                  </button>
                </div>
              </td>
              <% } else if(events[i].status === "rejected") { %>
              <td class="px-6 py-4">
                <span class="px-3 py-1 bg-red-500/10 text-red-700 rounded-full text-xs font-bold uppercase tracking-wider">Rejected</span>
              </td>
              <td class="px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">
                  <button class="p-2 hover:bg-[#1C2A3A]/5 rounded-lg transition-colors">
                    <a href="/admin/events/<%= events[i]._id%>">
                      <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </a>
                    </svg>
                  </button>
                </div>
              </td>
              <% } %>
            </tr>
            <% } %>
            <% } %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <!-- Pagination -->
      <% if (totalEvents > 0 && totalPages > 1) { %>
      <div class="max-w-7xl mx-auto px-6 py-4 border-t border-[#1C2A3A]/10 flex flex-col sm:flex-row items-center justify-between gap-6">
        <p class="text-sm text-[#1C2A3A]/60 order-2 sm:order-1">
          Showing <strong><%= events.length %></strong> of <strong><%= totalEvents %></strong> events
        </p>

        <div class="flex items-center gap-1 order-1 sm:order-2">
          <!-- Previous -->
          <% if (currentPage > 1) { %>
          <a href="/admin/events?p=<%= currentPage - 1 %><%= (searchQuery ? '&n=' + encodeURIComponent(searchQuery) : '') %><%= (selectedType && selectedType !== 'all' ? '&t=' + encodeURIComponent(selectedType) : '') %><%= (selectedSort && selectedSort !== 'name-asc' ? '&s=' + encodeURIComponent(selectedSort) : '') %>" class="px-2 py-2 text-[#1C2A3A]/60">&laquo;</a>
          <% } %>

          <!-- Page 1 -->
          <% if (currentPage !== 1) { %>
          <a href="/admin/events?p=1<%= (searchQuery ? '&n=' + encodeURIComponent(searchQuery) : '') %><%= (selectedType && selectedType !== 'all' ? '&t=' + encodeURIComponent(selectedType) : '') %><%= (selectedSort && selectedSort !== 'name-asc' ? '&s=' + encodeURIComponent(selectedSort) : '') %>" class="px-3 py-2 rounded-lg text-sm font-medium hover:bg-white text-[#1C2A3A]">1</a>
          <% } else { %>
          <span class="px-3 py-2 bg-[#1C2A3A] text-white rounded-lg text-sm font-bold">1</span>
          <% } %>

          <!-- Middle pages -->
          <% for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) { %>
          <% if (i === currentPage) { %>
          <span class="px-3 py-2 bg-[#1C2A3A] text-white rounded-lg text-sm font-bold"><%= i %></span>
          <% } else { %>
          <a href="/admin/events?p=<%= i %><%= (searchQuery ? '&n=' + encodeURIComponent(searchQuery) : '') %><%= (selectedType && selectedType !== 'all' ? '&t=' + encodeURIComponent(selectedType) : '') %><%= (selectedSort && selectedSort !== 'name-asc' ? '&s=' + encodeURIComponent(selectedSort) : '') %>" class="px-3 py-2 rounded-lg text-sm font-medium hover:bg-white text-[#1C2A3A]"><%= i %></a>
          <% } %>
          <% } %>

          <!-- Last page -->
          <% if (totalPages > 1 && currentPage !== totalPages) { %>
          <% if (totalPages > 3 && currentPage < totalPages - 1) { %>
          <span class="px-2 py-2 text-[#1C2A3A]/40">...</span>
          <% } %>
          <a href="/admin/events?p=<%= totalPages %><%= (searchQuery ? '&n=' + encodeURIComponent(searchQuery) : '') %><%= (selectedType && selectedType !== 'all' ? '&t=' + encodeURIComponent(selectedType) : '') %><%= (selectedSort && selectedSort !== 'name-asc' ? '&s=' + encodeURIComponent(selectedSort) : '') %>" class="px-3 py-2 rounded-lg text-sm font-medium hover:bg-white text-[#1C2A3A]"><%= totalPages %></a>
          <% } else if (totalPages > 1) { %>
          <span class="px-3 py-2 bg-[#1C2A3A] text-white rounded-lg text-sm font-bold"><%= totalPages %></span>
          <% } %>

          <!-- Next -->
          <% if (currentPage < totalPages) { %>
          <a href="/admin/events?p=<%= currentPage + 1 %><%= (searchQuery ? '&n=' + encodeURIComponent(searchQuery) : '') %><%= (selectedType && selectedType !== 'all' ? '&t=' + encodeURIComponent(selectedType) : '') %><%= (selectedSort && selectedSort !== 'name-asc' ? '&s=' + encodeURIComponent(selectedSort) : '') %>" class="px-2 py-2 text-[#1C2A3A]/60">&raquo;</a>
          <% } %>
        </div>
      </div>
      <% } %>
    </div>
  </main>

  <!-- Reject Reason Modal -->
  <div id="rejectModal" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-[#1C2A3A]/40 backdrop-blur-sm" onclick="closeRejectModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4">
      <div class="bg-[#F9F7F5] rounded-[2rem] shadow-2xl overflow-hidden ring-1 ring-[#1C2A3A]/5">
        <div class="px-8 py-6 border-b border-[#1C2A3A]/10 bg-white/50">
          <h3 class="text-xl font-heading font-bold text-[#1C2A3A]">Reject Event</h3>
          <p class="text-sm text-[#1C2A3A]/60 mt-1">Please provide a reason for rejection.</p>
        </div>
        <div class="p-8 space-y-6">
          <div>
            <label class="block text-xs font-bold uppercase tracking-widest text-[#1C2A3A]/60 mb-2">Reason</label>
            <textarea id="rejectReason" rows="4" class="w-full px-4 py-3 bg-white border border-[#1C2A3A]/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#1C2A3A]/20 resize-none" placeholder="e.g. Inappropriate content, Duplicate event..."></textarea>
          </div>
          <div class="flex gap-3">
            <button onclick="closeRejectModal()" class="flex-1 py-3 bg-white border border-[#1C2A3A]/10 text-[#1C2A3A] rounded-xl font-bold hover:bg-[#1C2A3A]/5 transition-colors">Cancel</button>
            <button onclick="confirmRejection()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-lg shadow-red-500/20 transition-all hover:scale-[1.02]">Confirm Rejection</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentEventId = null;

    function openRejectModal(eventId) {
      currentEventId = eventId;
      document.getElementById('rejectModal').classList.remove('hidden');
      document.getElementById('rejectReason').focus();
    }

    function closeRejectModal() {
      document.getElementById('rejectModal').classList.add('hidden');
      document.getElementById('rejectReason').value = '';
      currentEventId = null;
    }

    function confirmRejection() {
      const reason = document.getElementById('rejectReason').value.trim();
      if (!reason) {
        alert('Please enter a reason for rejection.');
        return;
      }

      // TODO: Replace with real API call
      console.log(`Rejecting event ${currentEventId} with reason: ${reason}`);
      alert(`Event ${currentEventId} has been rejected.`);

      closeRejectModal();
      // Optionally: reload or update row
    }
  </script>

</body>

</html>