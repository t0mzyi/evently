<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tickets â€” Evently</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;400;600;700&family=Inter:wght@300;400;500;600&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            theme: {
              navy: '#1C2A3A',
              cream: '#EAE0CF',
              orange: '#ED8842',
            }
          },
          fontFamily: {
            heading: ['Fraunces', 'serif'],
            sans: ['Inter', 'sans-serif'],
            mono: ['Courier Prime', 'monospace']
          }
        }
      }
    }
  </script>
  <style>
    body {
      background-color: #EAE0CF;
      color: #1C2A3A;
    }

    .ticket-card {
      display: flex;
      background-color: #1C2A3A;
      color: #EAE0CF;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px -10px rgba(28, 42, 58, 0.4);
      position: relative;
    }

    /* Perforation Line (Vertical) */
    .perforation {
      width: 2px;
      background-image: linear-gradient(to bottom, #EAE0CF 50%, rgba(255, 255, 255, 0) 0%);
      background-position: left;
      background-size: 2px 15px;
      background-repeat: repeat-y;
      opacity: 0.2;
      position: relative;
    }

    .notch {
      width: 20px;
      height: 20px;
      background-color: #EAE0CF;
      border-radius: 50%;
      position: absolute;
      left: -9px;
      z-index: 10;
    }

    .notch-top {
      top: -10px;
    }

    .notch-bottom {
      bottom: -10px;
    }

    @media (max-width: 768px) {
      .ticket-card {
        flex-direction: column;
      }

      .perforation {
        width: 100%;
        height: 2px;
        background-image: linear-gradient(to right, #EAE0CF 50%, rgba(255, 255, 255, 0) 0%);
        background-size: 15px 2px;
        background-repeat: repeat-x;
      }

      .notch {
        left: auto;
        top: -9px;
      }

      .notch-top {
        left: -10px;
        top: -9px;
      }

      .notch-bottom {
        right: -10px;
        top: -9px;
        bottom: auto;
      }
    }

    /* Print Specific Styles for Premium PDF */
    @media print {
      @page {
        size: A4;
        margin: 0;
      }

      body {
        background-color: #EAE0CF !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        margin: 0;
        padding: 40px !important;
      }

      /* Hide UI Elements */
      a[href="/dashboard/myBookings"],
      button,
      header button {
        display: none !important;
      }

      /* Ensure wrapper is full width */
      .max-w-5xl {
        max-width: 100% !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }

      /* Main Header styling for print */
      header {
        margin-bottom: 40px !important;
        border-bottom: 2px solid #1C2A3A !important;
      }

      /* Card styling adjustments for print */
      .ticket-card {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #1C2A3A;
        margin-bottom: 30px;
        page-break-inside: avoid;
      }

      /* High resolution images */
      img {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
  </style>
</head>

<body class="min-h-screen p-4 md:p-8 font-sans">

  <!-- Navbar Back Button -->
  <a href="/dashboard/myBookings" class="fixed top-6 left-6 z-50 flex items-center gap-2 text-[#1C2A3A]/70 hover:text-[#ED8842] transition-colors font-medium bg-[#EAE0CF]/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
      </path>
    </svg>
    <span class="font-heading tracking-wide">Return</span>
  </a>

  <div class="max-w-5xl mx-auto pt-20 pb-12">
    <header class="mb-12 flex items-end justify-between border-b pb-6 border-[#1C2A3A]/10">
      <div>
        <h1 class="text-4xl md:text-5xl font-heading text-[#1C2A3A] mb-1">My Tickets</h1>
        <p class="text-[#1C2A3A]/60 font-mono text-xs uppercase tracking-widest">Digital Entry Passes</p>
      </div>
      <button onclick="window.print()" class="hidden md:flex items-center gap-2 text-[#1C2A3A] font-bold uppercase text-xs hover:text-[#ED8842] transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
        </svg>
        Download PDF
      </button>
    </header>

    <% if (tickets && tickets.length > 0) { %>
    <div class="flex flex-col gap-8">
      <% tickets.forEach(function(ticket) { %>
      <!-- Horizontal Ticket Layout -->
      <div class="ticket-card group hover:-translate-y-1 transition-transform duration-300">

        <!-- Left: Image & Date -->
        <div class="w-full md:w-1/3 lg:w-1/4 relative min-h-[160px] md:min-h-[220px]">
          <img src="<%= (ticket.eventId.galleryImages && ticket.eventId.galleryImages.length > 0) ? ticket.eventId.galleryImages[0] : 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=1000&auto=format&fit=crop' %>" class="w-full h-full object-cover opacity-80 mix-blend-overlay" alt="Event">
          <div class="absolute inset-0 bg-gradient-to-r from-[#1C2A3A] to-transparent md:bg-gradient-to-r md:from-transparent md:to-[#1C2A3A]">
          </div>

          <!-- Date Badge -->
          <div class="absolute top-4 left-4 bg-[#EAE0CF] text-[#1C2A3A] p-3 text-center rounded-lg shadow-lg">
            <span class="block text-xs font-bold uppercase opacity-60">
              <%= new Date(ticket.eventId.startDate).toLocaleString('default', { month: 'short' }) %>
            </span>
            <span class="block text-2xl font-heading font-bold leading-none">
              <%= new Date(ticket.eventId.startDate).getDate() %>
            </span>
          </div>
        </div>

        <!-- Middle: Details -->
        <div class="flex-1 p-6 md:p-8 flex flex-col justify-center relative">
          <div class="flex items-start justify-between mb-4">
            <div>
              <span class="inline-block bg-[#ED8842] text-white text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded mb-2">
                <%= (typeof ticketTypesMap !== 'undefined' &&
                                            ticketTypesMap[ticket.ticketTypeId.toString()]) ?
                                            ticketTypesMap[ticket.ticketTypeId.toString()] : 'Entry Pass' %>
              </span>
              <h2 class="text-2xl md:text-3xl font-heading text-[#EAE0CF] leading-tight mb-1">
                <%= ticket.eventId.title %>
              </h2>
              <p class="text-[#EAE0CF]/60 text-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                  </path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <%= ticket.eventId.venueType === 'iconic' && ticket.eventId.venueId
                                            ? 'Iconic Venue' : (ticket.eventId.venueDetails ?
                                            ticket.eventId.venueDetails.name : 'Location TBA' ) %>
              </p>
            </div>
          </div>

          <div class="flex gap-8 border-t border-[#EAE0CF]/10 pt-4 mt-auto">
            <div>
              <p class="text-[10px] text-[#EAE0CF]/40 uppercase tracking-widest mb-1">Time</p>
              <p class="font-mono text-sm">
                <%= new Date(ticket.eventId.startDate).toLocaleTimeString('en-US', {
                                            hour: '2-digit', minute: '2-digit' }) %>
              </p>
            </div>
            <div>
              <p class="text-[10px] text-[#EAE0CF]/40 uppercase tracking-widest mb-1">Guest</p>
              <p class="font-mono text-sm capitalize">
                <%= ticket.holderDetails.firstName %>
                <%= ticket.holderDetails.lastName %>
              </p>
            </div>
            <div>
              <p class="text-[10px] text-[#EAE0CF]/40 uppercase tracking-widest mb-1">Seat</p>
              <p class="font-mono text-sm text-[#ED8842]">
                <%= ticket.seatTier %>-<%= ticket.seatNumber %>
              </p>
            </div>
          </div>
        </div>

        <!-- Perforation Divider -->
        <div class="relative flex-shrink-0 flex md:flex-col items-center justify-center">
          <div class="perforation h-full md:w-px w-full md:h-auto"></div>
          <div class="notch notch-top"></div>
          <div class="notch notch-bottom"></div>
        </div>

        <!-- Right: Stub & QR -->
        <div class="w-full md:w-48 bg-[#15202E] p-6 flex flex-col items-center justify-center text-center gap-4">
          <div class="bg-white p-2 rounded-lg" id="qrcode-<%= ticket.ticketId %>"></div>

          <div class="w-full overflow-hidden">
            <p class="text-[10px] text-[#EAE0CF]/40 uppercase tracking-widest mb-1">Pass ID</p>
            <p class="font-mono text-xs text-[#EAE0CF] truncate">
              <%= ticket.ticketId %>
            </p>
          </div>

          <% if(ticket.isUsed) { %>
          <div class="px-3 py-1 border border-red-500 text-red-500 text-[10px] font-bold uppercase rounded-full">
            Scanned</div>
          <% } else { %>
          <div class="flex items-center gap-1 text-[#EAE0CF]/60">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-[10px] font-bold uppercase">Ready</span>
          </div>
          <% } %>
        </div>

      </div>
      <% }); %>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const tickets = <%- JSON.stringify(tickets) %>;
        tickets.forEach(ticket => {
          const container = document.getElementById(`qrcode-${ticket.ticketId}`);
          if (container) {
            new QRCode(container, {
              text: ticket.ticketId, // QR Code is ONLY the ticketId as requested
              width: 90,
              height: 90,
              colorDark: "#1C2A3A",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.M
            });
          }
        });
      });
    </script>

    <div class="mt-12 text-center md:hidden">
      <button onclick="window.print()" class="px-6 py-3 bg-[#1C2A3A] text-[#EAE0CF] font-bold uppercase text-xs rounded-full shadow-lg">
        Download All Tickets
      </button>
    </div>

    <% } else { %>
    <div class="text-center py-24 opacity-50">
      <p class="text-xl font-heading text-[#1C2A3A]">No tickets found</p>
      <a href="/events" class="text-sm underline decoration-[#ED8842] mt-2 block">Browse Events</a>
    </div>
    <% } %>
  </div>
</body>

</html>