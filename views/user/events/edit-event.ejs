<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Event â€” Evently</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            heading: ['Fraunces', 'serif'],
            sans: ['Inter', 'sans-serif']
          },
          colors: {
            'apple-bg': '#EAE0CF',
            'apple-card': 'rgba(255, 255, 255, 0.6)',
            'apple-text': '#1C2A3A'
          }
        }
      }
    }
  </script>
  <style>
    .input-error {
      border: 1px solid #ef4444 !important;
      background-color: #fff5f5;
    }

    .error-text {
      color: #f87171;
      font-size: 10px;
      letter-spacing: 0.08em;
      margin-top: 4px;
      padding-left: 4px;
    }

    .glass-modal {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(25px);
    }

    .locked-input {
      background-color: rgba(28, 42, 58, 0.05);
      cursor: not-allowed;
    }

    #modal-results::-webkit-scrollbar,
    #image-preview-container::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    #modal-results::-webkit-scrollbar-thumb,
    #image-preview-container::-webkit-scrollbar-thumb {
      background: rgba(28, 42, 58, 0.1);
      border-radius: 10px;
    }
  </style>
</head>

<%- include('../../partials/navbar') %>
<%- include('../../partials/doodles') %>

<%
// ðŸ”‘ CRITICAL FIX: Attach venueDetails for iconic venues
if (event.venueType === 'iconic' && event.venueId && venues) {
  const foundVenue = venues.find(v => v._id.toString() === event.venueId.toString());
  if (foundVenue) {
    event.venueDetails = foundVenue;
  }
}
%>

<body class="bg-[#EAE0CF] text-[#1C2A3A] min-h-screen">

  <!-- AVAILABILITY MODAL -->
  <div id="availabilityModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-md hidden">
    <div class="glass-modal w-full max-w-2xl rounded-[2.5rem] p-8 md:p-12 shadow-2xl border border-white/40">
      <div class="flex justify-between items-start mb-8">
        <div>
          <h2 class="text-3xl font-heading text-[#1C2A3A] mb-1">Select a Venue</h2>
          <p class="text-[#1C2A3A]/60 font-sans text-sm">Find an available venue or use a custom location.</p>
        </div>
        <button type="button" onclick="useCustomVenue()" class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 bg-[#1C2A3A] text-white rounded-full hover:bg-[#2C3E50] transition-all">+ Custom Venue</button>
      </div>
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-2">Start Date</label>
            <input type="datetime-local" id="modal-start" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none">
          </div>
          <div>
            <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-2">End Date</label>
            <input type="datetime-local" id="modal-end" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none">
          </div>
        </div>
        <div class="relative">
          <input type="text" id="modal-search" placeholder="Search venues..." class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 pl-10 focus:outline-none">
          <svg class="w-4 h-4 text-[#1C2A3A]/40 absolute left-3.5 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2" />
          </svg>
        </div>
        <div id="modal-results" class="max-h-60 overflow-y-auto space-y-3 rounded-xl pr-2">
          <p class="text-center py-10 text-xs text-[#1C2A3A]/40">Select dates to check listed availability.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- IMAGE DELETE MODAL -->
  <div id="imageDeleteModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-md hidden">
    <div class="glass-modal w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-white/40">
      <h3 class="text-lg font-bold text-[#1C2A3A] mb-2">Remove Image?</h3>
      <p class="text-[#1C2A3A]/70 mb-6">Are you sure you want to remove this image from the gallery?</p>
      <div class="flex gap-3">
        <button onclick="hideModal('imageDeleteModal')" class="flex-1 px-4 py-2 border border-[#1C2A3A]/20 text-[#1C2A3A] rounded-xl">Cancel</button>
        <button onclick="confirmImageDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl">Remove</button>
      </div>
    </div>
  </div>

  <!-- TICKET DELETE CONFIRMATION MODAL -->
  <div id="ticketDeleteModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-md hidden">
    <div class="glass-modal w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-white/40">
      <h3 class="text-lg font-bold text-[#1C2A3A] mb-2">Delete Ticket Type?</h3>
      <p class="text-[#1C2A3A]/70 mb-6">Are you sure you want to delete this ticket type? This action cannot be undone.</p>
      <div class="flex gap-3">
        <button onclick="hideModal('ticketDeleteModal')" class="flex-1 px-4 py-2 border border-[#1C2A3A]/20 text-[#1C2A3A] rounded-xl">Cancel</button>
        <button onclick="confirmTicketDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl">Delete</button>
      </div>
    </div>
  </div>

  <!-- EVENT DELETE MODAL -->
  <div id="eventDeleteModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-md hidden">
    <div class="glass-modal w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-white/40">
      <h3 class="text-lg font-bold text-[#1C2A3A] mb-2">Delete Event?</h3>
      <p class="text-[#1C2A3A]/70 mb-6">This action cannot be undone. All tickets and data will be permanently deleted.</p>
      <div class="flex gap-3">
        <button onclick="hideModal('eventDeleteModal')" class="flex-1 px-4 py-2 border border-[#1C2A3A]/20 text-[#1C2A3A] rounded-xl">Cancel</button>
        <button onclick="deleteEvent()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl">Delete</button>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div id="successModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-md hidden">
    <div class="glass-modal w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-white/40 text-center">
      <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h3 class="text-lg font-bold text-[#1C2A3A] mb-2">Saved Successfully!</h3>
      <p class="text-[#1C2A3A]/70 mb-6">Your event has been updated.</p>
      <a href="/viewEventHost/<%= event._id%>?status=true&message=Event updated SuccessFully">
        <button class="w-full px-4 py-2 bg-[#1C2A3A] text-white rounded-xl">Continue</button>
      </a>
    </div>
  </div>

  <!-- ERROR MODAL -->
  <div id="errorModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-md hidden">
    <div class="glass-modal w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-white/40">
      <h3 class="text-lg font-bold text-[#1C2A3A] mb-2">Oops! Something went wrong</h3>
      <p id="errorMessage" class="text-[#1C2A3A]/70 mb-6">Please try again.</p>
      <button onclick="hideModal('errorModal')" class="w-full px-4 py-2 bg-[#1C2A3A] text-white rounded-xl">Close</button>
    </div>
  </div>

  <main class="pt-32 pb-16 px-6 relative z-10">
    <div class="max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-12">
        <div>
          <a href="/view-event?id=<%= event._id %>" class="inline-flex items-center gap-2 text-sm font-bold uppercase tracking-widest text-[#1C2A3A]/60 hover:text-[#1C2A3A] transition-colors mb-4">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Event
          </a>
          <h1 class="text-4xl font-heading text-[#1C2A3A]">Edit Event</h1>
          <p class="text-[#1C2A3A]/60 font-sans">Update your event details and manage capacity.</p>
        </div>
        <button type="button" id="changeVenueBtn" onclick="openModal()" class="<%= event.status === 'approved' ? 'hidden' : '' %> px-5 py-2 bg-white/80 hover:bg-white rounded-full text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A] border border-[#1C2A3A]/10 shadow-sm transition-all">
          Change Selection
        </button>
      </div>

      <div class="bg-white/60 backdrop-blur-xl rounded-[2.5rem] p-8 md:p-12 shadow-sm border border-white/40">
        <form id="eventForm" enctype="multipart/form-data" class="space-y-10" novalidate>
          <div id="locked-venue-notice" class="hidden p-5 bg-green-500/10 rounded-2xl border border-green-500/20 mb-4">
            <span class="text-sm font-medium text-green-800 flex items-center gap-2">
              <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> Venue Secured.
            </span>
          </div>

          <div id="form-fields" class="space-y-10">

            <!-- EVENT TITLE -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="col-span-2">
                <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Event Title</label>
                <input id="titleInput" name="title" type="text" value="<%= event.title || '' %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:outline-none">
                <p id="titleError" class="error-text hidden"></p>
              </div>

              <!-- DATES -->
              <div>
                <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Start Date</label>
                <input type="datetime-local" id="final-start" name="startDate" value="<%= new Date(event.startDate).toISOString().slice(0, 16) %>" class="w-full border border-[#1C2A3A]/10 rounded-xl px-4 py-3 text-sm focus:outline-none">
                <p id="startDateError" class="error-text hidden"></p>
              </div>
              <div>
                <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">End Date</label>
                <input type="datetime-local" id="final-end" name="endDate" value="<%= new Date(event.endDate).toISOString().slice(0, 16) %>" class="w-full border border-[#1C2A3A]/10 rounded-xl px-4 py-3 text-sm focus:outline-none">
                <p id="endDateError" class="error-text hidden"></p>
              </div>

              <!-- VENUE TYPE HIDDEN INPUT -->
              <input type="hidden" id="venue-type-input" name="venueType" value="<%= event.venueType || 'iconic' %>">

              <!-- VENUE DISPLAY SECTION -->
              <div class="col-span-2" id="listed-display">
                <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Selected Venue</label>

                <!-- CLICKABLE VENUE DISPLAY -->
                <div id="final-venue-name-display" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 font-bold cursor-pointer hover:bg-white/70 transition-colors" onclick="<%= event.status !== 'approved' ? 'openModal()' : '' %>">
                  <%= 
                    event.venueType === 'iconic' 
                      ? (event.venueDetails?.name || 'Select a venue') 
                      : (event.venueDetails?.name || 'Custom venue')
                  %>
                </div>

                <!-- HIDDEN INPUTS FOR FORM SUBMISSION -->
                <input type="hidden" id="final-venue-name" name="venueName" value="<%= event.venueDetails?.name || '' %>">
                <input type="hidden" id="final-venue-id" name="venueId" value="<%= event.venueId || '' %>">
                <p id="venueError" class="error-text hidden"></p>
              </div>

              <!-- CUSTOM VENUE SECTION -->
              <div class="col-span-2 hidden space-y-6" id="custom-venue-fields">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="col-span-2">
                    <label class="text-[10px] font-bold text-[#1C2A3A]/40">VENUE NAME</label>
                    <input type="text" name="custom_name" value="<%= event.venueDetails?.name || '' %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3">
                    <p id="customNameError" class="error-text hidden"></p>
                  </div>
                  <div class="col-span-2">
                    <label class="text-[10px] font-bold text-[#1C2A3A]/40">ADDRESS</label>
                    <input type="text" name="custom_address" value="<%= event.venueDetails?.address || '' %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3">
                    <p id="customAddressError" class="error-text hidden"></p>
                  </div>
                  <div>
                    <label class="text-[10px] font-bold text-[#1C2A3A]/40">CITY</label>
                    <input type="text" name="custom_city" value="<%= event.venueDetails?.city || '' %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3">
                    <p id="customCityError" class="error-text hidden"></p>
                  </div>
                  <div>
                    <label class="text-[10px] font-bold text-[#1C2A3A]/40">STATE</label>
                    <input type="text" name="custom_state" value="<%= event.venueDetails?.state || '' %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3">
                    <p id="customStateError" class="error-text hidden"></p>
                  </div>
                  <div>
                    <label class="text-[10px] font-bold text-[#1C2A3A]/40">MAP LINK</label>
                    <input type="text" name="custom_mapLink" value="<%= event.venueDetails?.mapUrl || '' %>" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3">
                    <p id="customMapLinkError" class="error-text hidden"></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- GALLERY IMAGES -->
            <div class="pt-8 border-t border-[#1C2A3A]/5">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Gallery Photos</label>
              <div class="space-y-4">
                <div id="image-preview-container" class="flex flex-wrap gap-4 empty:hidden">
                  <% event.galleryImages.forEach(img => { %>
                  <div class="relative w-20 h-20 rounded-xl overflow-hidden group border border-[#1C2A3A]/10">
                    <img src="<%= img %>" class="w-full h-full object-cover">
                    <div onclick="showImageDeleteModal('<%= img %>')" class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity">
                      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" />
                      </svg>
                    </div>
                  </div>
                  <% }) %>
                </div>
                <div onclick="document.getElementById('image-upload').click()" class="border-2 border-dashed border-[#1C2A3A]/10 rounded-2xl p-8 text-center hover:bg-white/40 cursor-pointer transition-all group">
                  <p class="text-sm font-medium text-[#1C2A3A]/60 group-hover:text-[#1C2A3A]">Click to select images</p>
                  <input type="file" id="image-upload" name="galleryImages" multiple accept="image/*" class="hidden" onchange="handleImagePreview(event)">
                  <p id="imageError" class="error-text hidden"></p>
                </div>
              </div>
            </div>

            <!-- CATEGORY -->
            <div class="pt-8 border-t border-[#1C2A3A]/5">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Category</label>
              <select name="categoryId" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 appearance-none focus:outline-none">
                <% categories.forEach(cat => { %>
                <option value="<%=cat._id%>" <%= cat._id === event.categoryId ? 'selected' : '' %>><%=cat.name%></option>
                <% }) %>
              </select>
              <p id="categoryError" class="error-text hidden"></p>
            </div>

            <!-- TICKETS -->
            <div class="pt-8 border-t border-[#1C2A3A]/5">
              <div class="flex justify-between items-center mb-4">
                <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40">Ticket Configuration</label>
                <button type="button" onclick="addTicketType()" class="text-[10px] font-bold uppercase text-blue-600">+ Add Ticket</button>
              </div>
              <div id="ticketTypesContainer" class="space-y-4">
                <% event.ticketTypes.forEach((ticket, index) => { %>
                <div class="p-6 bg-white/40 border border-[#1C2A3A]/10 rounded-2xl relative group">
                  <button type="button" onclick="showTicketDeleteModal(this)" class="absolute top-4 right-4 text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">âœ•</button>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                      <input type="text" name="ticket_name[]" value="<%= ticket.name %>" class="w-full bg-white/50 border-b border-[#1C2A3A]/10 text-sm py-1 focus:outline-none">
                      <p class="error-text hidden ticket-name-error"></p>
                    </div>
                    <div>
                      <label class="text-[9px] font-bold opacity-40">PRICE</label>
                      <div class="flex items-center gap-2 mt-1">
                        <input type="number" name="ticket_price[]" value="<%= ticket.price %>" min="0" class="ticket-price-input w-full bg-white/50 rounded-lg px-3 py-2 text-sm" oninput="calculateTotalCapacity()" <%= event.status === 'approved' ? 'readonly' : '' %>>
                        <label class="flex items-center gap-1 cursor-pointer text-[9px]">
                          <input type="checkbox" class="ticket-free-checkbox w-4 h-4 text-[#1C2A3A] rounded" onchange="toggleFreeTicket(this)" <%= ticket.isFree ? 'checked' : '' %> <%= event.status === 'approved' ? 'disabled' : '' %>>
                          <span class="text-[#1C2A3A]/60">Free</span>
                        </label>
                      </div>
                      <p class="error-text hidden ticket-price-error"></p>
                    </div>
                    <div>
                      <label class="text-[9px] font-bold opacity-40">QTY</label>
                      <input type="number" name="ticket_quantityTotal[]" value="<%= ticket.quantityTotal %>" min="1" class="ticket-qty w-full bg-white/50 rounded-lg px-3 py-2 text-sm" oninput="calculateTotalCapacity()">
                      <p class="error-text hidden ticket-qty-error"></p>
                    </div>
                  </div>
                </div>
                <% }) %>
              </div>

              <!-- TOTAL CAPACITY DISPLAY -->
              <div class="mt-6">
                <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">
                  Total Event Capacity
                </label>
                <input type="text" id="display-capacity" class="w-full bg-gray-100 border border-[#1C2A3A]/20 rounded-xl px-4 py-3 focus:outline-none text-[#1C2A3A]/70" readonly value="<%= event.totalCapacity || 0 %>">
                <input type="hidden" id="max-capacity-input" name="totalCapacity" value="<%= event.totalCapacity || 0 %>">
              </div>
            </div>

            <!-- DESCRIPTION -->
            <div class="pt-8 border-t border-[#1C2A3A]/5">
              <label class="block text-[10px] font-bold uppercase tracking-widest text-[#1C2A3A]/40 mb-3">Description</label>
              <textarea name="description" rows="6" class="w-full bg-white/50 border border-[#1C2A3A]/10 rounded-xl px-4 py-3 focus:bg-white focus:outline-none transition-all"><%= event.description || '' %></textarea>
              <p id="descriptionError" class="error-text hidden"></p>
            </div>

            <!-- SUBMIT BUTTON -->
            <div class="pt-8 flex justify-end">
              <button id="publishBtn" type="submit" class="px-12 py-5 bg-[#1C2A3A] text-white rounded-2xl font-heading text-xl shadow-2xl hover:scale-105 transition-all">Save Changes</button>
            </div>
          </div>
          <div id="backendError" class="hidden p-5 bg-red-500/10 rounded-2xl border border-red-500/20 mb-4">
            <span class="text-sm font-medium text-red-800 flex items-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
              Error: <span id="backendErrorMessage"></span>
            </span>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // âœ… SAFE VENUE RENDERING
    const venues = <%- JSON.stringify(venues || []) %>;
    const modal = document.getElementById('availabilityModal');
    const modalResults = document.getElementById('modal-results');
    const modalStart = document.getElementById('modal-start');
    const modalEnd = document.getElementById('modal-end');
    const formFields = document.getElementById('form-fields');
    const changeVenueBtn = document.getElementById('changeVenueBtn');
    let selectedFiles = [];
    let currentImageToDelete = null;
    let ticketToDelete = null;

    document.addEventListener('DOMContentLoaded', () => {
      const eventStatus = '<%= event.status %>';
      const isApproved = eventStatus === 'approved';
      const venueType = '<%= event.venueType || "iconic" %>';

      // ðŸ”’ Lock fields if approved
      if (isApproved) {
        lockApprovedFields();
      } else {
        unlockAllFields();
        changeVenueBtn.classList.remove('hidden');
      }

      // Pre-fill modal dates
      modalStart.value = document.getElementById('final-start').value;
      modalEnd.value = document.getElementById('final-end').value;

      // Show correct venue section
      if (venueType === 'iconic') {
        document.getElementById('venue-type-input').value = 'iconic';
        document.getElementById('listed-display').classList.remove('hidden');
        document.getElementById('custom-venue-fields').classList.add('hidden');
      } else {
        document.getElementById('venue-type-input').value = 'custom';
        document.getElementById('listed-display').classList.add('hidden');
        document.getElementById('custom-venue-fields').classList.remove('hidden');
      }

      // âœ… IMMEDIATELY SHOW FORM (no blur)
      formFields.classList.remove('opacity-40', 'pointer-events-none', 'blur-[4px]');
      document.getElementById('locked-venue-notice').classList.remove('hidden');
    });

    function openModal() {
      modal.classList.remove('hidden');
      formFields.classList.add('opacity-40', 'pointer-events-none', 'blur-[4px]');
      changeVenueBtn.classList.add('hidden');
    }

    window.confirmVenue = function(id, name) {
      document.getElementById('final-venue-id').value = id;
      document.getElementById('final-venue-name').value = name;
      document.getElementById('final-venue-name-display').textContent = name;
      document.getElementById('venue-type-input').value = 'iconic';

      if ('<%= event.status %>' !== 'approved') {
        document.getElementById('final-start').readOnly = false;
        document.getElementById('final-end').readOnly = false;
        document.getElementById('final-start').classList.remove('locked-input');
        document.getElementById('final-end').classList.remove('locked-input');
      }

      document.getElementById('custom-venue-fields').classList.add('hidden');
      document.getElementById('listed-display').classList.remove('hidden');
      finishSelection();
    };

    window.useCustomVenue = function() {
      document.getElementById('venue-type-input').value = 'custom';
      document.getElementById('final-venue-id').value = '';
      document.getElementById('final-venue-name').value = '';
      document.getElementById('final-venue-name-display').textContent = 'Custom venue';

      if ('<%= event.status %>' !== 'approved') {
        document.getElementById('final-start').readOnly = false;
        document.getElementById('final-end').readOnly = false;
        document.getElementById('final-start').classList.remove('locked-input');
        document.getElementById('final-end').classList.remove('locked-input');
      }

      document.getElementById('listed-display').classList.add('hidden');
      document.getElementById('custom-venue-fields').classList.remove('hidden');
      finishSelection();
    };

    function finishSelection() {
      modal.classList.add('hidden');
      formFields.classList.remove('opacity-40', 'pointer-events-none', 'blur-[4px]');
      document.getElementById('locked-venue-notice').classList.remove('hidden');

      if ('<%= event.status %>' !== 'approved') {
        changeVenueBtn.classList.remove('hidden');
      }
    }

    // ðŸ”’ LOCK APPROVED FIELDS
    function lockApprovedFields() {
      const inputs = [
        document.getElementById('final-start'),
        document.getElementById('final-end')
      ];
      inputs.forEach(input => {
        if (input) {
          input.readOnly = true;
          input.classList.add('locked-input');
        }
      });

      document.querySelectorAll('input[name="ticket_price[]"]').forEach(input => {
        input.readOnly = true;
        input.classList.add('locked-input');
      });

      changeVenueBtn.classList.add('hidden');

      const bannerHtml = `
        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-8 rounded-r-xl">
          <div class="flex items-start">
            <svg class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            <div class="ml-3">
              <p class="text-sm text-amber-900 font-bold">Partial Editing Lock</p>
              <p class="text-xs text-amber-800 mt-1">
                Since <strong><%= event.ticketsSold || 0 %> tickets</strong> have already been sold, critical details like
                Date, Venue, and Ticket Prices are locked to prevent booking conflicts.
              </p>
            </div>
          </div>
        </div>
      `;
      document.querySelector('form').insertAdjacentHTML('afterbegin', bannerHtml);
    }

    // âœ… UNLOCK FOR PENDING/REJECTED
    function unlockAllFields() {
      const inputs = [
        document.getElementById('final-start'),
        document.getElementById('final-end')
      ];
      inputs.forEach(input => {
        if (input) {
          input.readOnly = false;
          input.classList.remove('locked-input');
        }
      });

      document.querySelectorAll('input[name="ticket_price[]"]').forEach(input => {
        input.readOnly = false;
        input.classList.remove('locked-input');
      });
    }

    // ... [KEEP ALL OTHER FUNCTIONS IDENTICAL] ...

    // Image handling
    function handleImagePreview(event) {
      const files = Array.from(event.target.files);
      files.forEach(file => {
        if (!selectedFiles.some(f => f.name === file.name)) {
          selectedFiles.push(file);
        }
      });
      renderImagePreviews();
    }

    function renderImagePreviews() {
      const container = document.getElementById('image-preview-container');
      container.innerHTML = selectedFiles.map((file, index) => `
        <div class="relative w-20 h-20 rounded-xl overflow-hidden group border border-[#1C2A3A]/10">
          <img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover">
          <div onclick="showImageDeleteModal('${URL.createObjectURL(file)}')" class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/>
            </svg>
          </div>
        </div>
      `).join('');
    }

    function showImageDeleteModal(imageUrl) {
      currentImageToDelete = imageUrl;
      showModal('imageDeleteModal');
    }

    function confirmImageDelete() {
      const container = document.getElementById('image-preview-container');
      const item = container.querySelector(`img[src="${currentImageToDelete}"]`)?.closest('div');
      if (item) {
        item.remove();
        hideModal('imageDeleteModal');
        currentImageToDelete = null;
      }
    }

    // âœ… TICKET DELETE CONFIRMATION
    function showTicketDeleteModal(button) {
      ticketToDelete = button.closest('.p-6');
      showModal('ticketDeleteModal');
    }

    function confirmTicketDelete() {
      if (ticketToDelete) {
        const ticketItems = document.querySelectorAll('#ticketTypesContainer > div.p-6');
        if (ticketItems.length <= 1) {
          showErrorModal('You must have at least one ticket type.');
          hideModal('ticketDeleteModal');
          return;
        }
        ticketToDelete.remove();
        calculateTotalCapacity();
        hideModal('ticketDeleteModal');
        ticketToDelete = null;
      }
    }

    // Modal search
    [document.getElementById('modal-search'), modalStart, modalEnd].forEach(el => {
      el.addEventListener('input', () => {
        const start = modalStart.value;
        const end = modalEnd.value;
        if (!start || !end) {
          modalResults.innerHTML = '<p class="text-center py-10 text-xs text-[#1C2A3A]/40">Select dates to check listed availability.</p>';
          return;
        }
        const filtered = venues.filter(v => v.name.toLowerCase().includes(document.getElementById('modal-search').value.toLowerCase()));
        modalResults.innerHTML = filtered.map(v => {
          const bookedIntervals = v.bookedOn || [];
          const isOverlapping = bookedIntervals.some(interval => {
            const [bookedStart, bookedEnd] = interval;
            return new Date(start) < new Date(bookedEnd) && new Date(end) > new Date(bookedStart);
          });
          const available = !isOverlapping;
          return `
            <div class="flex items-center justify-between p-4 bg-white/60 rounded-2xl border border-[#1C2A3A]/5">
              <div class="flex items-center gap-4">
                <img src="${v.image_url?.[0] || ''}" class="w-12 h-12 rounded-xl object-cover">
                <div>
                  <h4 class="text-sm font-bold text-[#1C2A3A]">${v.name}</h4>
                  <p class="text-[10px] text-[#1C2A3A]/50">${v.address}</p>
                </div>
              </div>
              ${available ? 
                `<button type="button" onclick="confirmVenue('${v._id}', '${v.name.replace(/'/g, "\\'")}')" class="px-5 py-2 bg-[#1C2A3A] text-white text-[10px] font-bold rounded-xl transition-all hover:scale-105">Select</button>` : 
                `<span class="text-[10px] font-bold text-red-400 uppercase bg-red-50 rounded-xl px-3 py-1">Booked</span>`
              }
            </div>`;
        }).join('');
      });
    });

    // FREE TICKET TOGGLE
    function toggleFreeTicket(checkbox) {
      const priceInput = checkbox.closest('.grid').querySelector('input[name="ticket_price[]"]');
      if (!priceInput) return;

      if (checkbox.checked) {
        priceInput.value = 0;
        priceInput.disabled = true;
        priceInput.classList.add('locked-input');
      } else {
        priceInput.disabled = false;
        priceInput.classList.remove('locked-input');
      }
      calculateTotalCapacity();
    }

    // CAPACITY CALCULATION
    function calculateTotalCapacity() {
      let total = 0;
      document.querySelectorAll('.ticket-qty').forEach(input => {
        const val = parseInt(input.value);
        if (!isNaN(val) && val > 0) total += val;
      });
      document.getElementById('max-capacity-input').value = total;
      document.getElementById('display-capacity').value = total;
    }

    // ADD TICKET
    function addTicketType() {
      const id = Date.now();
      document.getElementById('ticketTypesContainer').insertAdjacentHTML('beforeend', `
        <div id="row-${id}" class="p-6 bg-white/40 border border-[#1C2A3A]/10 rounded-2xl relative group">
          <button 
            type="button" 
            onclick="showTicketDeleteModal(this)"
            class="absolute top-4 right-4 text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
          >âœ•</button>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <input 
                type="text" 
                name="ticket_name[]" 
                placeholder="Ticket Type" 
                class="w-full bg-white/50 border-b border-[#1C2A3A]/10 text-sm py-1 focus:outline-none"
              >
              <p class="error-text hidden ticket-name-error"></p>
            </div>
            <div>
              <label class="text-[9px] font-bold opacity-40">PRICE</label>
              <div class="flex items-center gap-2 mt-1">
                <input 
                  type="number" 
                  name="ticket_price[]" 
                  value="0" 
                  min="0"
                  class="ticket-price-input w-full bg-white/50 rounded-lg px-3 py-2 text-sm"
                  oninput="calculateTotalCapacity()"
                >
                <label class="flex items-center gap-1 cursor-pointer text-[9px]">
                  <input 
                    type="checkbox" 
                    class="ticket-free-checkbox w-4 h-4 text-[#1C2A3A] rounded"
                    onchange="toggleFreeTicket(this)"
                  >
                  <span class="text-[#1C2A3A]/60">Free</span>
                </label>
              </div>
              <p class="error-text hidden ticket-price-error"></p>
            </div>
            <div>
              <label class="text-[9px] font-bold opacity-40">QTY</label>
              <input 
                type="number" 
                name="ticket_quantityTotal[]" 
                min="1"
                class="ticket-qty w-full bg-white/50 rounded-lg px-3 py-2 text-sm"
                oninput="calculateTotalCapacity()"
              >
              <p class="error-text hidden ticket-qty-error"></p>
            </div>
          </div>
        </div>
      `);
    }

    // FORM SUBMISSION
    document.getElementById('eventForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const publishBtn = document.getElementById('publishBtn');
      const errorDiv = document.getElementById('backendError');
      const errorMsgSpan = document.getElementById('backendErrorMessage');
      errorDiv.classList.add('hidden');
      publishBtn.disabled = true;
      publishBtn.textContent = 'Saving...';
      publishBtn.classList.add('opacity-75', 'cursor-not-allowed');

      // Clear errors
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
      document.querySelectorAll('.error-text').forEach(el => el.classList.add('hidden'));

      let isValid = true;

      function markError(input, errorMsg) {
        input.classList.add('input-error');
        let errEl = input.nextElementSibling;
        if (errEl && errEl.classList.contains('error-text')) {
          errEl.textContent = errorMsg;
          errEl.classList.remove('hidden');
        }
        isValid = false;
      }

      // Title
      const titleInput = document.getElementById('titleInput');
      if (!titleInput.value.trim()) markError(titleInput, 'Event title is required.');

      // Dates
      const startDateInput = document.getElementById('final-start');
      const endDateInput = document.getElementById('final-end');
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      if (!startDate) markError(startDateInput, 'Start date is required.');
      if (!endDate) markError(endDateInput, 'End date is required.');
      if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
        markError(endDateInput, 'End date must be after start date.');
      }

      // Venue
      const venueType = document.getElementById('venue-type-input').value;
      if (venueType === 'iconic') {
        if (!document.getElementById('final-venue-name').value.trim() || document.getElementById('final-venue-name-display').textContent === 'Select a venue') {
          markError(document.getElementById('final-venue-name-display'), 'Please select a venue.');
        }
      } else if (venueType === 'custom') {
        const fields = [{
            el: document.querySelector('[name="custom_name"]'),
            msg: 'Venue name is required.'
          },
          {
            el: document.querySelector('[name="custom_address"]'),
            msg: 'Address is required.'
          },
          {
            el: document.querySelector('[name="custom_city"]'),
            msg: 'City is required.'
          },
          {
            el: document.querySelector('[name="custom_state"]'),
            msg: 'State is required.'
          },
          {
            el: document.querySelector('[name="custom_mapLink"]'),
            msg: 'Map link is required.'
          }
        ];
        fields.forEach(f => {
          if (!f.el.value.trim()) markError(f.el, f.msg);
        });
      }

      // Images
      if (selectedFiles.length === 0 && document.querySelectorAll('#image-preview-container img').length === 0) {
        document.getElementById('imageError').textContent = 'At least one image is required.';
        document.getElementById('imageError').classList.remove('hidden');
        isValid = false;
      }

      // Category
      const catSelect = document.querySelector('[name="categoryId"]');
      if (!catSelect.value) {
        catSelect.classList.add('input-error');
        document.getElementById('categoryError').textContent = 'Please select a category.';
        document.getElementById('categoryError').classList.remove('hidden');
        isValid = false;
      }

      // âœ… GET TICKET ROWS ONCE (FIXED DUPLICATE DECLARATION)
      const ticketRows = document.querySelectorAll('#ticketTypesContainer > div.p-6');

      // Tickets validation
      if (ticketRows.length === 0) {
        alert('At least one ticket type is required.');
        isValid = false;
      } else {
        for (const row of ticketRows) {
          const nameInput = row.querySelector('[name="ticket_name[]"]');
          const qtyInput = row.querySelector('[name="ticket_quantityTotal[]"]');

          if (!nameInput || !qtyInput) {
            row.classList.add('border-red-500', 'border-2');
            isValid = false;
            continue;
          }

          const name = nameInput.value.trim();
          const qty = parseInt(qtyInput.value) || 0;

          if (!name) markError(nameInput, 'Ticket name is required.');
          if (qty <= 0) markError(qtyInput, 'Quantity must be greater than 0.');
        }
      }

      // Description
      const desc = document.querySelector('[name="description"]');
      if (!desc.value.trim()) {
        desc.classList.add('input-error');
        document.getElementById('descriptionError').textContent = 'Description is required.';
        document.getElementById('descriptionError').classList.remove('hidden');
        isValid = false;
      }

      if (!isValid) {
        publishBtn.disabled = false;
        publishBtn.textContent = 'Save Changes';
        publishBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        const firstError = document.querySelector('.input-error');
        if (firstError) firstError.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
        return;
      }

      // âœ… REBUILD TICKET DATA IN CORRECT ORDER âœ…
      const ticketData = [];
      for (const row of ticketRows) {
        const name = row.querySelector('[name="ticket_name[]"]').value.trim();
        const price = parseFloat(row.querySelector('input[name="ticket_price[]"]').value) || 0;
        const qty = parseInt(row.querySelector('[name="ticket_quantityTotal[]"]').value) || 0;
        if (name && qty > 0) {
          ticketData.push({
            name,
            price,
            qty
          });
        }
      }

      const formData = new FormData(this);

      // Remove old arrays
      formData.delete('ticket_name[]');
      formData.delete('ticket_price[]');
      formData.delete('ticket_quantityTotal[]');

      // Append in guaranteed order
      ticketData.forEach(ticket => {
        formData.append('ticket_name[]', ticket.name);
        formData.append('ticket_price[]', ticket.price.toString());
        formData.append('ticket_quantityTotal[]', ticket.qty.toString());
      });

      // Handle images
      formData.delete('galleryImages');
      selectedFiles.forEach(file => {
        formData.append('galleryImages', file);
      });

      // Submit
      fetch(`/editEvent/<%= event._id %>`, {
          method: 'PUT',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showModal('successModal');
          } else {
            errorMsgSpan.textContent = data.message || 'Failed to update event.';
            errorDiv.classList.remove('hidden');
            publishBtn.disabled = false;
            publishBtn.textContent = 'Save Changes';
            publishBtn.classList.remove('opacity-75', 'cursor-not-allowed');
          }
        })
        .catch(err => {
          console.error(err);
          errorMsgSpan.textContent = 'Network error. Please try again.';
          errorDiv.classList.remove('hidden');
          publishBtn.disabled = false;
          publishBtn.textContent = 'Save Changes';
          publishBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        });
    });

    // MODAL FUNCTIONS
    function showModal(id) {
      document.getElementById(id).classList.remove('hidden');
    }

    function hideModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    function deleteEvent() {
      fetch(`/api/events/<%= event._id %>`, {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            window.location.href = '/dashboard';
          } else {
            showErrorModal(data.message || 'Failed to delete event.');
          }
        })
        .catch(err => {
          showErrorModal('Network error: ' + err.message);
        });
    }

    function showErrorModal(message) {
      document.getElementById('errorMessage').textContent = message;
      showModal('errorModal');
    }

    calculateTotalCapacity();
  </script>
</body>

</html>